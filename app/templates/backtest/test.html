{% extends "base.html" %}

{% block head %}
<!-- –°—Ç–∏–ª–∏ –¥–ª—è –±—ç–∫—Ç–µ—Å—Ç–∞ -->
<link rel="stylesheet" href="/static/css/backtest.css">
{% endblock %}

{% block content %}
<div class="backtest-container">
    <div class="backtest-header">
        <h2><i class="fas fa-flask"></i> –¢–µ—Å—Ç–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞</h2>
        <p>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π frontend —Å—Ç—Ä—É–∫—Ç—É—Ä—ã</p>

        <!-- –ö–Ω–æ–ø–∫–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
        <button type="button" class="btn btn-warning btn-sm" onclick="alert('JavaScript —Ä–∞–±–æ—Ç–∞–µ—Ç!')" style="margin-top: 10px;">
            <i class="fas fa-check"></i> –¢–µ—Å—Ç JavaScript
        </button>

        <button type="button" class="btn btn-info btn-sm" onclick="testTemplateParameters()" style="margin-top: 10px; margin-left: 10px;">
            <i class="fas fa-bug"></i> –¢–µ—Å—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
        </button>

        <button type="button" class="btn btn-success btn-sm" onclick="testBacktestManager()" style="margin-top: 10px; margin-left: 10px;">
            <i class="fas fa-cogs"></i> –¢–µ—Å—Ç BacktestManager
        </button>
    </div>

    <!-- –°–µ–∫—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ -->
    <div id="template-parameters-section" class="template-parameters-section" style="display: block;">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-cogs"></i> –¢–µ—Å—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —à–∞–±–ª–æ–Ω–∞</h5>
            </div>
            <div class="card-body">
                <div id="template-parameters-display">
                    <p>–ó–¥–µ—Å—å –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —à–∞–±–ª–æ–Ω–∞</p>
                </div>

                <button type="button" class="btn btn-outline-primary btn-sm" id="edit-parameters-btn">
                    <i class="fas fa-edit"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
                </button>
            </div>
        </div>
    </div>

    <!-- –ö–æ–Ω—Å–æ–ª—å –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ -->
    <div class="card mt-4">
        <div class="card-header">
            <h5><i class="fas fa-terminal"></i> –ö–æ–Ω—Å–æ–ª—å –æ—Ç–ª–∞–¥–∫–∏</h5>
        </div>
        <div class="card-body">
            <div id="debug-console" style="background: #f8f9fa; padding: 10px; border-radius: 5px; font-family: monospace; min-height: 200px; max-height: 400px; overflow-y: auto;">
                <div>–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ JavaScript...</div>
            </div>
        </div>
    </div>
</div>

<!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º —Å—Ç–∏–ª–∏ –∏ —Å–∫—Ä–∏–ø—Ç—ã -->
<script>
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –¥–ª—è BacktestManager
    const templatesData = {{ templates_data|tojson }};
    console.log('üîç –¢–µ—Å—Ç–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞: –¥–∞–Ω–Ω—ã–µ —à–∞–±–ª–æ–Ω–æ–≤ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', templatesData);
</script>

<!-- JavaScript –¥–ª—è –±—ç–∫—Ç–µ—Å—Ç–∞ -->
<script src="/static/js/backtest.js"></script>
<script src="/static/js/test.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ –¢–µ—Å—Ç–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞!');

    // –î–∞–Ω–Ω—ã–µ —à–∞–±–ª–æ–Ω–æ–≤ –∏–∑ backend
    const templatesData = {{ templates_data|tojson }};
    console.log('üîç –î–∞–Ω–Ω—ã–µ —à–∞–±–ª–æ–Ω–æ–≤ –∏–∑ backend:', templatesData);

    // –ü–µ—Ä–µ–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤ BacktestManager
    if (window.backtestManager) {
        window.backtestManager.setTemplatesData(templatesData);

        // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –∫–æ–Ω—Å–æ–ª—å
        addToDebugConsole('‚úÖ BacktestManager –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
        addToDebugConsole('üìä –ó–∞–≥—Ä—É–∂–µ–Ω–æ —à–∞–±–ª–æ–Ω–æ–≤: ' + templatesData.length);
    } else {
        addToDebugConsole('‚ùå BacktestManager –Ω–µ –Ω–∞–π–¥–µ–Ω');
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Ñ—É–Ω–∫—Ü–∏–π
    if (typeof window.testTemplateParameters === 'function') {
        addToDebugConsole('‚úÖ testTemplateParameters –¥–æ—Å—Ç—É–ø–Ω–∞');
    } else {
        addToDebugConsole('‚ùå testTemplateParameters –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
    }
});

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –æ—Ç–ª–∞–¥–æ—á–Ω—É—é –∫–æ–Ω—Å–æ–ª—å
function addToDebugConsole(message) {
    const consoleDiv = document.getElementById('debug-console');
    if (consoleDiv) {
        const timestamp = new Date().toLocaleTimeString();
        consoleDiv.innerHTML += `<div>[${timestamp}] ${message}</div>`;
        consoleDiv.scrollTop = consoleDiv.scrollHeight;
    }
}

// –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º console.log –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –∫–æ–Ω—Å–æ–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
const originalConsoleLog = console.log;
console.log = function(...args) {
    originalConsoleLog.apply(console, args);

    // –î–æ–±–∞–≤–ª—è–µ–º –≤ –æ—Ç–ª–∞–¥–æ—á–Ω—É—é –∫–æ–Ω—Å–æ–ª—å —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    const message = args.map(arg =>
        typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
    ).join(' ');

    addToDebugConsole(message);
};

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è BacktestManager
window.testBacktestManager = function() {
    console.log('üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∞ BacktestManager');

    if (window.backtestManager) {
        console.log('‚úÖ BacktestManager –Ω–∞–π–¥–µ–Ω');
        console.log('üìä –î–∞–Ω–Ω—ã–µ —à–∞–±–ª–æ–Ω–æ–≤:', window.backtestManager.templatesData);
        console.log('üîß –ú–µ—Ç–æ–¥—ã:', Object.getOwnPropertyNames(Object.getPrototypeOf(window.backtestManager)));

        addToDebugConsole('‚úÖ –¢–µ—Å—Ç BacktestManager –ø—Ä–æ–π–¥–µ–Ω —É—Å–ø–µ—à–Ω–æ');
    } else {
        console.log('‚ùå BacktestManager –Ω–µ –Ω–∞–π–¥–µ–Ω');
        addToDebugConsole('‚ùå BacktestManager –Ω–µ –Ω–∞–π–¥–µ–Ω');
    }
};
</script>

{% endblock %}
