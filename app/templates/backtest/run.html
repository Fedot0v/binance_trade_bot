{% extends "base.html" %}

{% block head %}
<!-- –°—Ç–∏–ª–∏ –¥–ª—è –±—ç–∫—Ç–µ—Å—Ç–∞ -->
<link rel="stylesheet" href="/static/css/backtest.css">
{% endblock %}

{% block content %}
<div class="backtest-container">
    <div class="backtest-header">
        <h2><i class="fas fa-rocket"></i> –ë—ç–∫—Ç–µ—Å—Ç —Å—Ç—Ä–∞—Ç–µ–≥–∏–π</h2>
        <p>–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ —Ç–æ—Ä–≥–æ–≤—ã–µ —à–∞–±–ª–æ–Ω—ã —Å—Ç—Ä–∞—Ç–µ–≥–∏–π –Ω–∞ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö</p>

        <!-- –ü—Ä–æ—Å—Ç–∞—è —Ç–µ—Å—Ç–æ–≤–∞—è –∫–Ω–æ–ø–∫–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ JavaScript -->
        <button type="button" class="btn btn-warning btn-sm" onclick="alert('JavaScript —Ä–∞–±–æ—Ç–∞–µ—Ç!')" style="margin-top: 10px;">
            <i class="fas fa-check"></i> –¢–µ—Å—Ç JavaScript
        </button>

        <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —à–∞–±–ª–æ–Ω–∞ -->
        <button type="button" class="btn btn-info btn-sm" onclick="testTemplateParameters()" style="margin-top: 10px; margin-left: 10px;">
            <i class="fas fa-bug"></i> –¢–µ—Å—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
        </button>
    </div>

    {% if error %}
    <div class="alert alert-danger">
        <strong>–û—à–∏–±–∫–∞:</strong> {{ error }}
    </div>
    {% endif %}

    <div class="modal fade" id="loadingModal" tabindex="-1" role="dialog" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header border-0 bg-gradient">
                    <h5 class="modal-title">
                        <i class="fas fa-chart-line text-warning"></i>
                        –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –±—ç–∫—Ç–µ—Å—Ç —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
                    </h5>
                </div>
                <div class="modal-body text-center">
                    <div class="loading-spinner mb-4">
                        <div class="spinner-border text-warning" role="status" style="width: 4rem; height: 4rem;">
                            <span class="sr-only">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                        </div>
                    </div>

                    <h5 class="mt-3 text-light">–ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å Binance...</h5>
                    <p class="text-muted mb-4">–°–∫–∞—á–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</p>

                    <div class="progress-container">
                        <div class="progress mb-3" style="height: 12px; border-radius: 10px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated"
                                 role="progressbar"
                                 style="width: 0%; background: linear-gradient(90deg, #F0B90B 0%, #F8D90F 100%);"
                                 aria-valuenow="0"
                                 aria-valuemin="0"
                                 aria-valuemax="100">
                            </div>
                        </div>
                        <small class="text-muted">–ü—Ä–æ–≥—Ä–µ—Å—Å: <span id="progressPercent">0</span>%</small>
                    </div>

                    <div class="loading-steps mt-4">
                        <div class="step active" id="step1">
                            <i class="fas fa-download text-success"></i>
                            <span>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö</span>
                        </div>
                        <div class="step" id="step2">
                            <i class="fas fa-cogs text-info"></i>
                            <span>–û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö</span>
                        </div>
                        <div class="step" id="step3">
                            <i class="fas fa-chart-bar text-warning"></i>
                            <span>–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –±—ç–∫—Ç–µ—Å—Ç–∞</span>
                        </div>
                        <div class="step" id="step4">
                            <i class="fas fa-calculator text-primary"></i>
                            <span>–†–∞—Å—á–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if result and result.task_id %}
    <div class="alert alert-success mt-4">
        <i class="fas fa-check-circle"></i> –ë—ç–∫—Ç–µ—Å—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ!
        <p><strong>ID –∑–∞–¥–∞—á–∏:</strong> {{ result.task_id }}</p>
        <p>–í—ã –º–æ–∂–µ—Ç–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –µ–≥–æ —Å—Ç–∞—Ç—É—Å –∏ –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∑–¥–µ—Å—å: <a href="/backtest/results/{{ result.task_id }}" class="alert-link">–ü—Ä–æ—Å–º–æ—Ç—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</a></p>
    </div>
    {% elif result and result.message %}
        <div class="alert alert-info mt-4">
            {{ result.message }}
        </div>
    {% endif %}

    <form id="backtestForm" action="/backtest/run/" method="post" enctype="multipart/form-data">
        <div class="row">
            <div class="col-md-6">
                <h4>–í—ã–±–æ—Ä —à–∞–±–ª–æ–Ω–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏</h4>
                <div class="form-group">
                    <label for="template_id">–®–∞–±–ª–æ–Ω —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏:</label>
                    <select name="template_id" id="template_id" class="form-control" required>
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —à–∞–±–ª–æ–Ω —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏...</option>
                        {% for template in templates %}
                            <option value="{{ template.id }}" data-strategy-config-id="{{ template.strategy_config_id }}">{{ template.template_name }}</option>
                        {% endfor %}
                    </select>
                    <small class="form-text text-muted">
                        {% for template in templates %}
                            <div id="desc-{{ template.id }}" class="template-desc" style="display: none;">
                                <strong>{{ template.template_name }}:</strong> {{ template.description or '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç' }}
                            </div>
                        {% endfor %}
                    </small>
                </div>

                <div class="form-group">
                    <label for="initial_balance">–ù–∞—á–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å ($):</label>
                    <input type="number" name="initial_balance" id="initial_balance" class="form-control" value="10000" min="100" step="100" required>
                </div>



                <!-- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —à–∞–±–ª–æ–Ω–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ -->
                <div id="template-parameters-section" class="template-parameters-section" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-cogs"></i> –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —à–∞–±–ª–æ–Ω–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏</h5>
                            <small class="text-muted">–ù–∞–∂–º–∏—Ç–µ "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º –±—ç–∫—Ç–µ—Å—Ç–∞</small>
                        </div>
                        <div class="card-body">
                            <div id="template-parameters-display">
                                <!-- –ó–¥–µ—Å—å –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –ø–∞—Ä–∞–º–µ—Ç—Ä—ã -->
                            </div>

                            <!-- –ö–Ω–æ–ø–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
                            <div class="mt-3">
                                <button type="button" class="btn btn-outline-primary btn-sm" id="edit-parameters-btn">
                                    <i class="fas fa-edit"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
                                </button>
                            </div>

                            <!-- –§–æ—Ä–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ (—Å–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
                            <div id="template-parameters-edit" class="mt-3" style="display: none;">
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <strong>–í–Ω–∏–º–∞–Ω–∏–µ:</strong> –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø–æ–≤–ª–∏—è–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ —Ç–µ–∫—É—â–∏–π –±—ç–∫—Ç–µ—Å—Ç. –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —à–∞–±–ª–æ–Ω–∞ –Ω–µ –±—É–¥—É—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.
                                </div>

                                <div id="parameters-form">
                                    <!-- –ó–¥–µ—Å—å –±—É–¥—É—Ç –ø–æ–ª—è –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
                                </div>

                                <div class="parameter-actions">
                                    <button type="button" class="btn btn-success btn-sm" id="save-parameters-btn">
                                        <i class="fas fa-save"></i> –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                                    </button>
                                    <button type="button" class="btn btn-secondary btn-sm" id="cancel-edit-btn">
                                        <i class="fas fa-times"></i> –û—Ç–º–µ–Ω–∞
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <div class="col-md-6">
                <h4>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–∞–Ω–Ω—ã—Ö</h4>
                <div class="form-group" id="symbol-group">
                    <label for="symbol">–¢–æ—Ä–≥–æ–≤–∞—è –ø–∞—Ä–∞:</label>
                    <select name="symbol" id="symbol" class="form-control">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞–ª—é—Ç—É...</option>
                        {% for symbol in symbols %}
                            <option value="{{ symbol }}">{{ symbol }}</option>
                        {% endfor %}
                    </select>
                    <small class="form-text text-muted" id="symbol-info">
                        <i class="fas fa-info-circle"></i> –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —Å —Ä–µ–∞–ª—å–Ω–æ–≥–æ API Binance<br>
                        <i class="fas fa-clock"></i> –ò–Ω—Ç–µ—Ä–≤–∞–ª –±—É–¥–µ—Ç –≤–∑—è—Ç –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —à–∞–±–ª–æ–Ω–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏<br>
                        <i class="fas fa-exchange-alt"></i> –ö–æ–º–ø–µ–Ω—Å–∞—Ü–∏–æ–Ω–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∑–∏—Ç BTC –∏ ETH
                    </small>
                    <!-- –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                    <div class="debug-info" style="font-size: 12px; color: #666; margin-top: 5px;">
                        <strong>Debug:</strong> symbols = {{ symbols }}, count = {{ symbols|length }}
                    </div>
                </div>

                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏–æ–Ω–Ω–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ -->
                <div id="compensation-info" class="alert alert-info" style="display: none;">
                    <i class="fas fa-info-circle"></i>
                    <strong>–ö–æ–º–ø–µ–Ω—Å–∞—Ü–∏–æ–Ω–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è:</strong> –î–ª—è —ç—Ç–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –ø–æ BTC –∏ ETH. –í—ã–±–æ—Ä –≤–∞–ª—é—Ç—ã –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.
                </div>

                <div class="form-group">
                    <label for="start_date">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞:</label>
                    <input type="date" name="start_date" id="start_date" class="form-control" required>
                </div>

                <div class="form-group">
                    <label for="end_date">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è:</label>
                    <input type="date" name="end_date" id="end_date" class="form-control" required>
                </div>

                <div class="alert alert-secondary mt-4" id="data-range-info" style="display:none;">
                    <i class="fas fa-info-circle"></i>
                    <strong>–î–∏–∞–ø–∞–∑–æ–Ω –¥–∞–Ω–Ω—ã—Ö:</strong>
                    <span id="btc-range"></span>
                    <span id="eth-range" style="display:none;"></span>
                </div>

            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12 text-center">
                <button type="submit" class="btn btn-primary btn-lg" id="runBacktestBtn">
                    <i class="fas fa-play"></i> –ó–∞–ø—É—Å—Ç–∏—Ç—å –±—ç–∫—Ç–µ—Å—Ç
                </button>
                <!-- –¢–µ—Å—Ç–æ–≤–∞—è –∫–Ω–æ–ø–∫–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ -->
                <button type="button" class="btn btn-secondary btn-lg ml-2" id="testModalBtn" style="margin-left: 10px;">
                    <i class="fas fa-eye"></i> –¢–µ—Å—Ç –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
                </button>
            </div>
        </div>
    </form>
</div>

<!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º —Å—Ç–∏–ª–∏ –∏ —Å–∫—Ä–∏–ø—Ç—ã -->
<script>
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –¥–ª—è BacktestManager
    const templatesData = {{ templates_data|tojson }};
    console.log('üîç –î–∞–Ω–Ω—ã–µ —à–∞–±–ª–æ–Ω–æ–≤ –∏–∑ backend:', templatesData);
</script>

<!-- JavaScript –¥–ª—è –±—ç–∫—Ç–µ—Å—Ç–∞ -->
<script src="/static/js/backtest.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ JavaScript –∑–∞–≥—Ä—É–∂–µ–Ω –∏ DOMContentLoaded —Å—Ä–∞–±–æ—Ç–∞–ª!');

    // –î–∞–Ω–Ω—ã–µ —à–∞–±–ª–æ–Ω–æ–≤ –∏–∑ backend
    const templatesData = {{ templates_data|tojson }};
    console.log('üîç –î–∞–Ω–Ω—ã–µ —à–∞–±–ª–æ–Ω–æ–≤ –∏–∑ backend:', templatesData);

    // –ü–µ—Ä–µ–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤ BacktestManager
    if (window.backtestManager) {
        window.backtestManager.setTemplatesData(templatesData);
    }

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    const today = new Date();
    const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);

    const startDateInput = document.getElementById('start_date');
    const endDateInput = document.getElementById('end_date');

    if (startDateInput) {
        startDateInput.value = weekAgo.toISOString().split('T')[0];
    }
    if (endDateInput) {
        endDateInput.value = today.toISOString().split('T')[0];
    }
});
</script>

{% endblock %}
