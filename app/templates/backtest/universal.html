{% extends "base.html" %}

{% block content %}
<div class="universal-backtest-container">
    <div class="backtest-header">
        <h2><i class="fas fa-rocket"></i> Универсальный бэктест стратегий</h2>
        <p>Продвинутая система тестирования с улучшенной архитектурой</p>

        <div class="backtest-features">
            <div class="feature-item">
                <i class="fas fa-cogs text-primary"></i>
                <span>Улучшенная архитектура</span>
            </div>
            <div class="feature-item">
                <i class="fas fa-chart-line text-success"></i>
                <span>Детальная статистика</span>
            </div>
            <div class="feature-item">
                <i class="fas fa-tachometer-alt text-warning"></i>
                <span>Высокая производительность</span>
            </div>
            <div class="feature-item">
                <i class="fas fa-plug text-info"></i>
                <span>Совместим со существующими стратегиями</span>
            </div>
        </div>
    </div>

    {% if error %}
    <div class="alert alert-danger">
        <strong>Ошибка:</strong> {{ error }}
    </div>
    {% endif %}

    <form id="universalBacktestForm" action="/backtest/universal/" method="post" enctype="multipart/form-data">
        <div class="row">
            <div class="col-lg-8">
                <div class="card config-card">
                    <div class="card-header">
                        <h4><i class="fas fa-sliders-h"></i> Конфигурация бэктеста</h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h5>Основные настройки</h5>

                                <div class="form-group">
                                    <label for="template_id">Шаблон стратегии:</label>
                                    <select name="template_id" id="template_id" class="form-control" required>
                                        <option value="">Выберите шаблон стратегии...</option>
                                        {% for template in templates %}
                                            <option value="{{ template.id }}" data-strategy-config-id="{{ template.strategy_config_id }}">
                                                {{ template.template_name }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                    <small class="form-text text-muted">
                                        {% for template in templates %}
                                            <div id="desc-{{ template.id }}" class="template-desc" style="display: none;">
                                                <strong>{{ template.template_name }}:</strong> {{ template.description or 'Описание отсутствует' }}
                                            </div>
                                        {% endfor %}
                                    </small>
                                </div>

                                <div class="form-group">
                                    <label for="initial_balance">Начальный баланс ($):</label>
                                    <input type="number" name="initial_balance" id="initial_balance" class="form-control" value="10000" min="100" step="100" required>
                                </div>

                                <div class="form-group">
                                    <label for="data_source">Источник данных:</label>
                                    <select name="data_source" id="data_source" class="form-control" required>
                                        <option value="download">Скачать с Binance</option>
                                        <option value="file">Загрузить файл</option>
                                    </select>
                                </div>

                                <!-- Дополнительные настройки для файлов -->
                                <div class="form-group" id="file-upload-group" style="display: none;">
                                    <label for="csv_file">CSV файл:</label>
                                    <input type="file" name="csv_file" id="csv_file" class="form-control-file" accept=".csv">
                                    <small class="form-text text-muted">Выберите CSV файл с историческими данными</small>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <h5>Параметры данных</h5>

                                <div class="form-group" id="symbol-group">
                                    <label for="symbol">Торговая пара:</label>
                                    <select name="symbol" id="symbol" class="form-control">
                                        <option value="">Выберите валюту...</option>
                                        {% for symbol in symbols %}
                                            <option value="{{ symbol }}">{{ symbol }}</option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="start_date">Дата начала:</label>
                                    <input type="date" name="start_date" id="start_date" class="form-control" required>
                                </div>

                                <div class="form-group">
                                    <label for="end_date">Дата окончания:</label>
                                    <input type="date" name="end_date" id="end_date" class="form-control" required>
                                </div>

                                <!-- Информация о компенсационной стратегии -->
                                <div id="compensation-info" class="alert alert-info" style="display: none;">
                                    <i class="fas fa-info-circle"></i>
                                    <strong>Компенсационная стратегия:</strong> Будут загружены данные BTC и ETH автоматически.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card config-card">
                    <div class="card-header">
                        <h4><i class="fas fa-wrench"></i> Расширенные настройки</h4>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label for="fee_rate">Комиссия taker (%):</label>
                            <input type="number" name="fee_rate" id="fee_rate" class="form-control" value="0.04" min="0" max="1" step="0.01">
                            <small class="text-muted">Комиссия за исполнение ордера</small>
                        </div>

                        <div class="form-group">
                            <label for="slippage_bps">Проскальзывание (bps):</label>
                            <input type="number" name="slippage_bps" id="slippage_bps" class="form-control" value="5" min="0" max="100" step="1">
                            <small class="text-muted">1 bps = 0.01%</small>
                        </div>

                        <div class="form-group">
                            <label for="spread_bps">Спред (bps):</label>
                            <input type="number" name="spread_bps" id="spread_bps" class="form-control" value="2" min="0" max="50" step="0.5">
                            <small class="text-muted">Разница между ценой покупки и продажи</small>
                        </div>

                        <div class="form-group">
                            <label for="intrabar_mode">Режим SL/TP:</label>
                            <select name="intrabar_mode" id="intrabar_mode" class="form-control">
                                <option value="stopfirst">Сначала стоп-лосс</option>
                                <option value="tpfirst">Сначала тейк-профит</option>
                                <option value="mid">Ближайшая цель</option>
                            </select>
                            <small class="text-muted">Как обрабатывать SL/TP в одной свече</small>
                        </div>
                    </div>
                </div>

                <div class="card config-card">
                    <div class="card-header">
                        <h4><i class="fas fa-info-circle"></i> Информация</h4>
                    </div>
                    <div class="card-body">
                        <div class="info-item">
                            <i class="fas fa-check-circle text-success"></i>
                            <span>Использует ваши существующие стратегии</span>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-check-circle text-success"></i>
                            <span>Улучшенная обработка ошибок</span>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-check-circle text-success"></i>
                            <span>Детальная статистика результатов</span>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-check-circle text-success"></i>
                            <span>Гибкая конфигурация комиссий</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12 text-center">
                <button type="submit" class="btn btn-primary btn-lg" id="runUniversalBacktestBtn">
                    <i class="fas fa-rocket"></i> Запустить универсальный бэктест
                </button>

            </div>
        </div>
    </form>

    {% if result %}
    <div class="results-section">
        <div class="row">
            <div class="col-12">
                <div class="results-header">
                    <h3><i class="fas fa-chart-bar"></i> Результаты бэктеста: {{ result.strategy_name }}</h3>
                    <div class="results-meta">
                        <span class="badge badge-info">
                            <i class="fas fa-calendar"></i> {{ result.start_date.strftime('%Y-%m-%d %H:%M') }} - {{ result.end_date.strftime('%Y-%m-%d %H:%M') }}
                        </span>
                        <span class="badge badge-secondary">
                            <i class="fas fa-coins"></i> {{ result.symbol }}
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ключевые метрики -->
        <div class="row">
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-icon">
                        <i class="fas fa-wallet"></i>
                    </div>
                    <div class="metric-content">
                        <div class="metric-value">${{ "{:,.2f}".format(result.final_balance) }}</div>
                        <div class="metric-label">Финальный баланс</div>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="metric-content">
                        <div class="metric-value {{ 'positive' if result.total_return_pct > 0 else 'negative' }}">
                            {{ "{:+.1f}%".format(result.total_return_pct) }}
                        </div>
                        <div class="metric-label">Общая доходность</div>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-icon">
                        <i class="fas fa-bullseye"></i>
                    </div>
                    <div class="metric-content">
                        <div class="metric-value">{{ "{:.1f}%".format(result.win_rate) }}</div>
                        <div class="metric-label">Win Rate</div>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-icon">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <div class="metric-content">
                        <div class="metric-value text-danger">{{ "{:.1f}%".format(result.max_drawdown) }}</div>
                        <div class="metric-label">Макс. просадка</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Детальная статистика -->
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card result-card">
                    <div class="card-header">
                        <h5><i class="fas fa-list"></i> Статистика сделок</h5>
                    </div>
                    <div class="card-body">
                        <div class="metric-row">
                            <div class="metric-item">
                                <div class="metric-label">Всего сделок</div>
                                <div class="metric-value">{{ result.total_trades }}</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">Прибыльных</div>
                                <div class="metric-value text-success">{{ result.winning_trades or 0 }}</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">Убыточных</div>
                                <div class="metric-value text-danger">{{ result.losing_trades or 0 }}</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">Profit Factor</div>
                                <div class="metric-value">{{ "{:.2f}".format(result.profit_factor) }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card result-card">
                    <div class="card-header">
                        <h5><i class="fas fa-analytics"></i> Риск-метрики</h5>
                    </div>
                    <div class="card-body">
                        <div class="metric-row">
                            <div class="metric-item">
                                <div class="metric-label">Коэффициент Шарпа</div>
                                <div class="metric-value">{{ "{:.2f}".format(result.sharpe_ratio) }}</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">Макс. просадка</div>
                                <div class="metric-value text-danger">{{ "{:.2f}%".format(result.max_drawdown) }}</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">Средний PnL</div>
                                <div class="metric-value">{{ "${:,.2f}".format(result.avg_pnl or 0) }}</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">Лучшая сделка</div>
                                <div class="metric-value text-success">{{ "${:,.2f}".format(result.best_trade or 0) }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {% if result.trades %}
        <div class="row mt-4">
            <div class="col-12">
                <div class="card result-card">
                    <div class="card-header">
                        <h5><i class="fas fa-table"></i> Детали сделок</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover trades-table">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Монета</th>
                                        <th>Вход</th>
                                        <th>Выход</th>
                                        <th>Сторона</th>
                                        <th>Размер</th>
                                        <th>PnL</th>
                                        <th>PnL %</th>
                                        <th>Причина</th>
                                        <th>Время входа</th>
                                        <th>Время выхода</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for trade in result.trades %}
                                    <tr>
                                        <td>{{ loop.index }}</td>
                                        <td>
                                            <span class="badge badge-info">{{ trade.symbol }}</span>
                                        </td>
                                        <td>${{ "{:.2f}".format(trade.entry_price) }}</td>
                                        <td>${{ "{:.2f}".format(trade.exit_price) }}</td>
                                        <td>
                                            <span class="badge {{ 'badge-success' if trade.side == 'long' else 'badge-danger' }}">
                                                {{ trade.side.upper() }}
                                            </span>
                                        </td>
                                        <td>${{ "{:.2f}".format(trade.size) }}</td>
                                        <td class="{{ 'text-success' if trade.pnl > 0 else 'text-danger' }}">
                                            ${{ "{:.2f}".format(trade.pnl) }}
                                        </td>
                                        <td class="{{ 'text-success' if trade.pnl_pct > 0 else 'text-danger' }}">
                                            {{ "{:+.2f}%".format(trade.pnl_pct) }}
                                        </td>
                                        <td>
                                            <span class="badge badge-secondary">{{ trade.reason }}</span>
                                        </td>
                                        <td>{{ trade.entry_time.strftime('%m-%d %H:%M') }}</td>
                                        <td>{{ trade.exit_time.strftime('%m-%d %H:%M') }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}
</div>

<style>
.universal-backtest-container {
    padding: 20px;
}

.backtest-features {
    display: flex;
    justify-content: space-around;
    margin: 20px 0;
    flex-wrap: wrap;
}

.feature-item {
    display: flex;
    align-items: center;
    margin: 10px;
    padding: 10px 15px;
    background: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #dee2e6;
}

.feature-item i {
    margin-right: 8px;
    font-size: 1.2em;
}

.config-card {
    margin-bottom: 20px;
    border: none;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.config-card .card-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 8px 8px 0 0 !important;
}

.metric-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    border: 1px solid #e9ecef;
    display: flex;
    align-items: center;
}

.metric-icon {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.5em;
    margin-right: 15px;
}

.metric-content .metric-value {
    font-size: 1.8em;
    font-weight: bold;
    color: #2c3e50;
    margin-bottom: 5px;
}

.metric-content .metric-value.positive {
    color: #27ae60;
}

.metric-content .metric-value.negative {
    color: #e74c3c;
}

.metric-content .metric-label {
    color: #7f8c8d;
    font-size: 0.9em;
}

.info-item {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
}

.info-item i {
    margin-right: 10px;
    width: 20px;
}

.results-section {
    margin-top: 30px;
}

.results-header {
    margin-bottom: 30px;
    text-align: center;
}

.results-meta {
    margin-top: 10px;
}

.metric-row {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
}

.metric-item {
    flex: 1;
    min-width: 120px;
    text-align: center;
}

.metric-item .metric-label {
    font-size: 0.85em;
    color: #6c757d;
    margin-bottom: 5px;
}

.metric-item .metric-value {
    font-size: 1.2em;
    font-weight: bold;
    color: #495057;
}

.result-card {
    border: none;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    border-radius: 8px;
}

.result-card .card-header {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    color: white;
    border-radius: 8px 8px 0 0 !important;
}

.trades-table {
    font-size: 0.9em;
}

@media (max-width: 768px) {
    .metric-card {
        flex-direction: column;
        text-align: center;
    }

    .metric-icon {
        margin-right: 0;
        margin-bottom: 10px;
    }

    .backtest-features {
        flex-direction: column;
        align-items: center;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Управление формой
    const dataSourceSelect = document.getElementById('data_source');
    const fileUploadGroup = document.getElementById('file-upload-group');
    const symbolGroup = document.getElementById('symbol-group');
    const compensationInfo = document.getElementById('compensation-info');
    const templateSelect = document.getElementById('template_id');

    // Показ описания шаблона стратегии
    templateSelect.addEventListener('change', function() {
        // Скрываем все описания
        document.querySelectorAll('.template-desc').forEach(desc => {
            desc.style.display = 'none';
        });

        // Показываем выбранное описание
        const selectedValue = this.value;
        if (selectedValue) {
            const desc = document.getElementById('desc-' + selectedValue);
            if (desc) {
                desc.style.display = 'block';
            }
        }

        // Управление UI для компенсационной стратегии
        const selectedOption = this.options[this.selectedIndex];
        const strategyConfigId = selectedOption.getAttribute('data-strategy-config-id');

        if (strategyConfigId === '2') {
            symbolGroup.style.display = 'none';
            compensationInfo.style.display = 'block';
        } else {
            symbolGroup.style.display = 'block';
            compensationInfo.style.display = 'none';
        }
    });

    // Управление источником данных
    dataSourceSelect.addEventListener('change', function() {
        if (this.value === 'file') {
            fileUploadGroup.style.display = 'block';
            // Для файла делаем символ обязательным
            document.getElementById('symbol').required = true;
        } else {
            fileUploadGroup.style.display = 'none';
            document.getElementById('symbol').required = false;
        }
    });

    // Устанавливаем даты по умолчанию
    const today = new Date();
    const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);

    document.getElementById('end_date').value = today.toISOString().split('T')[0];
    document.getElementById('start_date').value = weekAgo.toISOString().split('T')[0];

    // Обработка отправки формы
    const form = document.getElementById('universalBacktestForm');
    form.addEventListener('submit', function(e) {
        // Валидация
        if (!form.checkValidity()) {
            e.preventDefault();
            form.reportValidity();
            return;
        }

        // Показываем сообщение о запуске
        const btn = document.getElementById('runUniversalBacktestBtn');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Запуск бэктеста...';
        btn.disabled = true;

        // Возвращаем исходное состояние через 2 секунды (на случай ошибки)
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }, 2000);
    });
});
</script>
{% endblock %}
