{% extends "base.html" %}
{% block title %}Торговый Хаб{% endblock %}
{% block content %}
<div class="trade-hub">
    <div class="trade-header">
        <h2><i class="fas fa-robot"></i> Торговый бот — управление</h2>
        <div class="trade-status-indicator">
            {% if active_bot and active_bot.status == 'active' %}
                <div class="status-dot active"></div>
                <span>Бот активен</span>
            {% else %}
                <div class="status-dot inactive"></div>
                <span>Бот остановлен</span>
            {% endif %}
        </div>
    </div>

    <!-- Баланс пользователя -->
    <div class="balance-section">
        <div class="balance-card">
            <div class="balance-header">
                <i class="fas fa-wallet"></i>
                <h3>Баланс пользователя</h3>
            </div>
            {% if user_balance is not none %}
                <div class="balance-value">
                    <span class="balance-amount">{{ user_balance }}</span>
                    <span class="balance-currency">USDT</span>
                </div>
                <form method="post" action="/trade/ui/refresh-balance/" class="inline-form">
                    <button type="submit" class="refresh-btn" title="Обновить баланс">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </form>
            {% else %}
                <div class="balance-placeholder">
                    <form method="post" action="/trade/ui/user-balance/" class="inline-form">
                        <button type="submit" class="request-btn">
                            <i class="fas fa-download"></i>
                            Запросить баланс
                        </button>
                    </form>
                    <span class="balance-note">
                        Баланс ещё не получен, нажмите кнопку для запроса
                    </span>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- API ключ -->
    <div class="apikey-section">
        {% if apikey and apikey.is_active %}
            <div class="apikey-card active">
                <i class="fas fa-key"></i>
                <span>API-ключ активен</span>
                <div class="status-badge active">Активен</div>
            </div>
        {% else %}
            <div class="apikey-card inactive">
                <i class="fas fa-exclamation-triangle"></i>
                <span>Нет активного Binance API-ключа</span>
                <div class="status-badge inactive">Неактивен</div>
            </div>
        {% endif %}
    </div>

    <!-- Активный шаблон -->
    <div class="template-section">
        <h3><i class="fas fa-cog"></i> Текущий активный шаблон</h3>
        {% if apikey and apikey.is_active and active_template %}
            <div class="template-card active">
                <div class="template-header">
                    <h4>{{ active_template.template_name }}</h4>
                    <div class="template-badge active">Активный</div>
                </div>
                
                <div class="template-details">
                    <div class="detail-grid">
                        <div class="detail-item">
                            <span class="detail-label">Тикер</span>
                            <span class="detail-value">{{ active_template.symbol.value }}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Таймфрейм</span>
                            <span class="detail-value">{{ active_template.interval.value }}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Плечо</span>
                            <span class="detail-value">{{ active_template.leverage }}x</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Доля депозита</span>
                            <span class="detail-value">{{ active_template.entry_pct }}%</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Депозит</span>
                            <span class="detail-value">{{ active_template.initial_balance or 'Не задан' }}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Стратегия</span>
                            <span class="detail-value">{{ strategy_config.name }}</span>
                        </div>
                    </div>
                </div>

                <div class="template-parameters">
                    <h5>Параметры стратегии</h5>
                    <div class="parameters-grid">
                        {% for key, value in active_template.parameters.items() %}
                            <div class="parameter-item">
                                <span class="parameter-key">{{ key }}</span>
                                <span class="parameter-value">{{ value }}</span>
                            </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Баланс Binance -->
                <div class="binance-balance">
                    {% if balance %}
                        <div class="balance-info">
                            <span class="balance-label">Баланс Binance:</span>
                            <span class="balance-amount">{{ balance.available }} USDT</span>
                        </div>
                        {% if active_template.initial_balance %}
                            <div class="profit-info">
                                <span class="profit-label">Прибыль:</span>
                                {% if template_profit > 0 %}
                                    <span class="profit-positive">+{{ template_profit_pct }}% ({{ template_profit }} USDT)</span>
                                {% elif template_profit < 0 %}
                                    <span class="profit-negative">{{ template_profit_pct }}% ({{ template_profit }} USDT)</span>
                                {% else %}
                                    <span class="profit-zero">0%</span>
                                {% endif %}
                                <span class="initial-balance">(Старт: {{ active_template.initial_balance }})</span>
                            </div>
                        {% endif %}
                    {% else %}
                        {% if active_template.initial_balance %}
                            <div class="balance-info">
                                <span class="balance-label">Стартовый баланс:</span>
                                <span class="balance-amount">{{ active_template.initial_balance }} USDT</span>
                                <span class="balance-note">Получите текущий баланс для расчёта доходности</span>
                            </div>
                        {% endif %}
                        <form method="post" action="/strategy-templates/fix-initial-balance/{{ active_template.id }}/" class="inline-form">
                            <button type="submit" class="fix-balance-btn">
                                <i class="fas fa-save"></i>
                                Зафиксировать стартовый баланс
                            </button>
                        </form>
                    {% endif %}
                </div>
            </div>
        {% else %}
            <div class="template-card inactive">
                <i class="fas fa-exclamation-circle"></i>
                <span>Нет активного шаблона!</span>
            </div>
        {% endif %}
    </div>

    <!-- Управление ботом -->
    <div class="bot-control-section">
        <h3><i class="fas fa-play-circle"></i> Управление ботом</h3>
        <div class="bot-control-card">
            <div class="bot-status">
                <span class="status-label">Статус:</span>
                {% if active_bot and active_bot.status == 'active' %}
                    <span class="status-value active">Активен</span>
                    <form method="post" action="/trade/ui/stop/" class="inline-form">
                        <button type="submit" class="stop-btn">
                            <i class="fas fa-stop"></i>
                            Остановить
                        </button>
                    </form>
                {% else %}
                    <span class="status-value inactive">Остановлен</span>
                    <form method="post" action="/trade/ui/start/" class="inline-form">
                        <button type="submit" class="start-btn">
                            <i class="fas fa-play"></i>
                            Запустить
                        </button>
                    </form>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Все шаблоны -->
    <div class="templates-section">
        <h3><i class="fas fa-list"></i> Все ваши шаблоны</h3>
        {% if all_templates_data %}
            <div class="templates-grid">
                {% for tdata in all_templates_data %}
                {% set template = tdata.tpl %}
                {% set strategy_cfg = tdata.strategy_config %}
                <div class="template-item {% if template.is_active %}active{% endif %}">
                    <div class="template-item-header">
                        <h4>{{ template.template_name }}</h4>
                        <span class="template-symbol">{{ template.symbol.value }}/{{ template.interval.value }}</span>
                        {% if template.is_active %}
                            <div class="active-badge">Активный</div>
                        {% else %}
                            <form method="post" action="/strategy-templates/set-active/{{ template.id }}/" class="inline-form">
                                <button type="submit" class="activate-btn">
                                    <i class="fas fa-check"></i>
                                    Активировать
                                </button>
                            </form>
                        {% endif %}
                    </div>
                    
                    <div class="template-item-details">
                        <div class="detail-row">
                            <span>Плечо: {{ template.leverage }}x</span>
                            <span>Доля: {{ template.entry_pct }}%</span>
                        </div>
                        <div class="detail-row">
                            <span>Депозит: {{ template.initial_balance or 'Не задан' }}</span>
                        </div>
                    </div>

                    {% if template.initial_balance %}
                        <div class="template-profit">
                            <span class="profit-label">Старт: {{ template.initial_balance }} USDT</span>
                            {% if tdata.profit is not none and tdata.profit_pct is not none %}
                                <span class="profit-value">
                                    {% if tdata.profit > 0 %}
                                        <span class="profit-positive">+{{ tdata.profit_pct }}% ({{ tdata.profit }} USDT)</span>
                                    {% elif tdata.profit < 0 %}
                                        <span class="profit-negative">{{ tdata.profit_pct }}% ({{ tdata.profit }} USDT)</span>
                                    {% else %}
                                        <span class="profit-zero">0%</span>
                                    {% endif %}
                                </span>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="no-templates">
                <i class="fas fa-inbox"></i>
                <span>Нет ни одного шаблона</span>
            </div>
        {% endif %}
    </div>

    <!-- Последняя сделка -->
    <div class="last-deal-section">
        <h3><i class="fas fa-chart-line"></i> Последняя сделка</h3>
        {% if last_deal %}
            <div class="deal-card">
                <div class="deal-header">
                    <span class="deal-symbol">{{ last_deal.symbol }}</span>
                    <span class="deal-side {{ last_deal.side.lower() }}">{{ last_deal.side }}</span>
                </div>
                <div class="deal-details">
                    <div class="deal-price">
                        <span class="price-label">Entry:</span>
                        <span class="price-value">{{ last_deal.entry_price }}</span>
                    </div>
                    <div class="deal-price">
                        <span class="price-label">Exit:</span>
                        <span class="price-value">{{ last_deal.exit_price or "—" }}</span>
                    </div>
                    <div class="deal-pnl">
                        <span class="pnl-label">PnL:</span>
                        <span class="pnl-value">{{ last_deal.pnl or "—" }}</span>
                    </div>
                </div>
            </div>
        {% else %}
            <div class="no-deals">
                <i class="fas fa-chart-bar"></i>
                <span>Нет сделок</span>
            </div>
        {% endif %}
    </div>

    <!-- Быстрые ссылки -->
    <div class="quick-links-section">
        <h3><i class="fas fa-link"></i> Быстрые ссылки</h3>
        <div class="quick-links-grid">
            <a href="/deals/ui/" class="quick-link">
                <i class="fas fa-list-alt"></i>
                <span>Мои сделки</span>
            </a>
            <a href="/strategy-config/list/" class="quick-link">
                <i class="fas fa-cogs"></i>
                <span>Стратегии</span>
            </a>
            <a href="/strategy-templates/list/" class="quick-link">
                <i class="fas fa-sliders-h"></i>
                <span>Мои настройки</span>
            </a>
            <a href="/users/ui/me" class="quick-link">
                <i class="fas fa-user"></i>
                <span>Профиль пользователя</span>
            </a>
        </div>
    </div>

    <!-- Логи -->
    <div class="logs-section">
        <h3><i class="fas fa-terminal"></i> Логи</h3>
        <div class="logs-container">
            <pre class="trade-hub-logs">
{% for log in logs %}
{{ log.timestamp }} — {{ log.message }}
{% endfor %}
            </pre>
        </div>
    </div>
</div>
{% endblock %}
