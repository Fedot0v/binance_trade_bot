{% extends "base.html" %}
{% block title %}Создать шаблон стратегии{% endblock %}
{% block content %}
<div class="template-form">
    <h2>Создать шаблон стратегии</h2>
    <form method="get" action="/strategy-templates/create/" class="form-select-strategy">
        <label>Стратегия:
            <select name="strategy_config_id" required onchange="this.form.submit()">
                <option value="">Выберите стратегию</option>
                {% for strategy in strategies %}
                    <option value="{{ strategy.id }}"
                        {% if strategy_config_id and strategy.id == strategy_config_id|int %}selected{% endif %}
                    >{{ strategy.name }}</option>
                {% endfor %}
            </select>
        </label>
        <noscript><button type="submit" class="button">Показать параметры</button></noscript>
    </form>

    <form method="post" action="/strategy-templates/create/" class="form-main">
        <label>Название шаблона:
            <input type="text" name="template_name" required>
        </label>
        <label>Описание:
            <input type="text" name="description">
        </label>
        <label>Плечо:
            <input type="number" name="leverage" step="any" required>
        </label>
        <input type="hidden" name="strategy_config_id" value="{{ strategy_config_id }}">
        <label>Тикер (symbol):
            <select name="symbol" required>
                {% for s in symbols %}
                    <option value="{{ s }}">{{ s }}</option>
                {% endfor %}
            </select>
        </label>
        <label>Таймфрейм (interval):
            <select name="interval" required>
                {% for i in intervals %}
                    <option value="{{ i }}">{{ i }}</option>
                {% endfor %}
            </select>
        </label>
        {% if parameters %}
            <h4>Параметры стратегии:</h4>

            {% for key, value in parameters.items() %}
                <label>{{ key }}:

                    {% if key in percentage_params %}
                        {# Показываем оба значения: в долях (для ввода) и в процентах (для понимания) #}
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="text" name="param_{{ key }}" value="{{ value }}" style="flex: 1;" data-percentage-param="true">
                            <span style="color: #F0B90B; font-weight: bold; white-space: nowrap;" data-percentage-display>
                                {% if value is number %}
                                    ({{ "%.1f"|format(value * 100) }}%)
                                {% elif value %}
                                    {% if '.' in value or value.replace('.', '').isdigit() %}
                                        {% set num_value = value | float %}
                                        ({{ "%.1f"|format(num_value * 100) }}%)
                                    {% else %}
                                        ({{ value }})
                                    {% endif %}
                                {% else %}
                                    ({{ value }})
                                {% endif %}
                            </span>
                        </div>
                    {% else %}
                        <input type="text" name="param_{{ key }}" value="{{ value }}">
                    {% endif %}
                </label>
            {% endfor %}
            <small><em>Значения вводятся в долях (0.02 = 2%), рядом показаны проценты для удобства</em></small>
        {% endif %}
        <button type="submit" class="button">Сохранить</button>
    </form>
    <a href="/strategy-templates/list/" class="button-secondary">Назад к списку</a>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Находим все поля ввода с процентными параметрами
    const percentageInputs = document.querySelectorAll('input[data-percentage-param="true"]');

    percentageInputs.forEach(function(input) {
        // Получаем соответствующий span для отображения процентов
        const displaySpan = input.parentElement.querySelector('[data-percentage-display]');

        // Функция для обновления отображения процентов
        function updatePercentageDisplay() {
            const value = input.value.trim();

            if (value === '' || value === '0') {
                displaySpan.textContent = '(0.0%)';
                return;
            }

            // Проверяем, является ли значение числом
            const numValue = parseFloat(value);
            if (!isNaN(numValue)) {
                const percentage = (numValue * 100).toFixed(1);
                displaySpan.textContent = `(${percentage}%)`;
            } else {
                displaySpan.textContent = `(${value})`;
            }
        }

        // Обновляем при изменении значения
        input.addEventListener('input', updatePercentageDisplay);

        // Обновляем при потере фокуса (для случаев копирования/вставки)
        input.addEventListener('blur', updatePercentageDisplay);

        // Инициализируем отображение для текущего значения
        updatePercentageDisplay();
    });
});
</script>

{% endblock %}
