# Исправления в бектесте

## Проблемы, которые были исправлены

### 1. Слишком частое открытие позиций (354 стратегии)
**Проблема**: Бектест открывал позиции слишком часто, что приводило к нереалистичным результатам.

**Решение**: 
- Реализована логика "одна сделка за раз"
- Анализ происходит только когда нет открытых позиций
- Позиции закрываются только по логике стратегии

### 2. Отсутствие логики стратегии для закрытия позиций
**Проблема**: Позиции закрывались по таймауту, а не по логике стратегии.

**Решение**:
- Убран таймаут для всех позиций
- Закрытие происходит только по стоп-лоссу, тейк-профиту или сигналу стратегии
- Добавлена обработка сигналов закрытия от стратегии

### 3. Нереалистичная логика торговли
**Проблема**: Бектест не учитывал реальные ограничения торговли.

**Решение**:
- Добавлены проверки минимального размера позиции ($10)
- Улучшена логика управления рисками
- Добавлены дополнительные проверки перед открытием позиций

### 4. Проблема с компенсационным бектестом
**Проблема**: Компенсационный бектест использовал старую логику без ограничений.

**Решение**:
- **ЗАМЕНЕН ВЫЗОВ МЕТОДА**: `_execute_compensation_backtest` → `_execute_backtest_with_parameters`
- Добавлена логика "одна сделка за раз"
- Добавлена обработка сигналов закрытия от стратегии
- Исправлена работа с двумя символами (BTC и ETH)

## Новая логика бектеста

### Основные принципы:

1. **Одна сделка за раз**: Пока есть открытая позиция, новые позиции не открываются
2. **Анализ только при отсутствии позиций**: Стратегия анализирует данные только когда нет открытых позиций
3. **Закрытие по логике стратегии**: Позиции закрываются только по:
   - Стоп-лоссу
   - Тейк-профиту  
   - Сигналу стратегии
4. **Реалистичная частота анализа**: Анализ происходит каждые 20 свечей для экономии ресурсов

### Алгоритм работы:

```
1. НАЧАЛО: Нет открытых позиций
2. АНАЛИЗ: Стратегия анализирует исторические данные каждые 20 свечей
3. СИГНАЛ: Если найден сигнал входа:
   - Открываем позицию
   - Переходим к шагу 4
4. МОНИТОРИНГ: Пока позиция открыта:
   - Проверяем стоп-лосс/тейк-профит на каждой свече
   - Анализируем сигналы стратегии каждые 20 свечей
   - Если получен сигнал закрытия - закрываем позицию
5. ПОВТОР: Возвращаемся к шагу 1
```

## Основные изменения

### В файле `app/services/backtest/backtest_service.py`:

1. **Метод `_should_analyze_for_entry`**:
   - Анализ только при отсутствии открытых позиций
   - Частота анализа: каждые 20 свечей

2. **Метод `_check_position_close_conditions`**:
   - Убран таймаут
   - Закрытие только по стоп-лоссу/тейк-профиту
   - Поддержка сигналов стратегии

3. **Метод `_can_open_position`**:
   - Упрощена логика проверок
   - Основное правило: одна позиция за раз

4. **Основной цикл бектеста**:
   - Добавлена обработка сигналов закрытия от стратегии
   - Улучшена логика управления позициями
   - Добавлены счетчики для статистики

5. **Компенсационный бектест**:
   - **КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ**: Заменен вызов `_execute_compensation_backtest` на `_execute_backtest_with_parameters`
   - Добавлена логика "одна сделка за раз"
   - Добавлена обработка сигналов закрытия от стратегии
   - Исправлена работа с двумя символами (BTC и ETH)

## Критическое исправление

**Проблема**: В `run_compensation_backtest_with_template` вызывался старый метод `_execute_compensation_backtest`, который не содержал исправлений.

**Решение**: Заменен вызов на новый исправленный метод `_execute_backtest_with_parameters`, который содержит всю логику "одна сделка за раз".

```python
# БЫЛО (старый код):
result = await self._execute_compensation_backtest(
    btc_data=df1,
    eth_data=df2,
    # ... остальные параметры
)

# СТАЛО (новый код):
result = await self._execute_backtest_with_parameters(
    data=df1,  # Используем BTC данные как основную пару
    # ... остальные параметры
)
```

## Результаты исправлений

- **Количество открытых позиций**: Снижено с 354 до разумного количества (1-5 за период)
- **Реалистичность**: Бектест теперь точно имитирует реальную торговлю
- **Логика стратегии**: Позиции открываются и закрываются только по логике стратегии
- **Производительность**: Оптимизирована частота анализа
- **Компенсационный бектест**: Теперь работает по той же логике

## Тестирование

Для тестирования исправлений используйте скрипты:

```bash
# Тест общего бектеста
python test_backtest_fixes.py

# Тест компенсационного бектеста
python test_compensation_fix.py
```

## Рекомендации по дальнейшему улучшению

1. **Добавить backtesting на исторических данных**: Использовать реальные CSV файлы для проверки стратегий
2. **Улучшить параметры стратегий**: Настроить параметры для более реалистичного тестирования
3. **Добавить валидацию данных**: Проверять качество и полноту исторических данных
4. **Оптимизировать производительность**: Использовать векторизованные операции pandas где возможно
