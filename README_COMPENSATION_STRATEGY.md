# Стратегия "Компенсация и реакция"

## Описание

Стратегия "Компенсация и реакция" - это инновационный подход к торговле криптовалютами, который сочетает в себе логику входа по тренду с системой компенсации убытков через коррелированные активы.

## Основные принципы

### База стратегии
- **Основной актив**: BTC
- **Страховка**: ETH
- **Подход**: Работаем руками, каждую сделку обсуждаем по скрину
- **Цель**: Входить даже без четкого тренда, страховаться против движения, по итогу дня быть в плюсе без крупных просадок

### Размеры и старт
- **Первый вход**: BTC $1500, плечо x10
- **ETH**: Не трогаем до сигнала на компенсацию

## Логика входа в BTC

Стратегия использует проверенную логику "новичка" для входа в BTC:

```python
# Параметры EMA
ema_fast = 10
ema_slow = 30
trend_threshold = 0.001  # 0.1%

# Сигнал генерируется при пересечении EMA
if ema_fast > ema_slow and diff > trend_threshold:
    signal = 'long'
elif ema_fast < ema_slow and diff > trend_threshold:
    signal = 'short'
else:
    signal = 'hold'
```

## Условия компенсации через ETH

Компенсация запускается при одновременном выполнении условий:

1. **BTC идет против позиции >0.25%**
2. **Произошло за ≤15 минут**
3. **На BTC либо:**
   - 2 свечи подряд в противоположную сторону
   - 1 импульс >0.4%

### Логика компенсации
```python
def should_trigger_compensation(self, btc_df, current_price):
    # Проверяем движение против позиции
    price_change_pct = abs(current_price - entry_price) / entry_price
    
    if price_change_pct < 0.0025:  # 0.25%
        return False
        
    # Проверяем время с момента входа
    if time_since_entry > 15 minutes:
        return False
        
    # Проверяем свечи или импульс
    return (candles_against >= 2 or impulse_detected)
```

## Менеджмент позиций

### Правила закрытия
1. **Если обе сделки убыточны** → фиксируем обе, не "докупаемся"
2. **Если ETH компенсировал, а BTC "болтается"** → BTC закрываем в ноль/минимальный минус и закрываем обе
3. **Если обе в прибыли** → фиксируем обе сразу, без жадности

### Стоп-лоссы и таймауты
- **BTC SL**: 1.2% от цены входа (при $1500 x10 это ≈-$18)
- **ETH SL**: 1.0% (короче, т.к. сделка краткая; при $3000 x10 это ≈-$30)
- **Таймаут**: Любая сделка принудительно закрывается через 1 час

## Параметры стратегии

```python
{
    # Параметры для BTC (логика новичка)
    "ema_fast": 10,
    "ema_slow": 30,
    "trend_threshold": 0.001,
    "btc_deposit_prct": 0.05,      # 5% от депозита
    "btc_stop_loss_pct": 0.012,    # 1.2%
    
    # Параметры для ETH (компенсация)
    "eth_deposit_prct": 0.1,       # 10% от депозита
    "eth_stop_loss_pct": 0.01,     # 1.0%
    
    # Параметры компенсации
    "compensation_threshold": 0.0025,      # 0.25%
    "compensation_time_window": 15,        # 15 минут
    "impulse_threshold": 0.004,            # 0.4%
    "candles_against_threshold": 2,        # 2 свечи
    "max_trade_duration": 60               # 1 час
}
```

## Ментальная модель

> "Не гадаем тренд — реагируем на факт. Если пошло не туда — включаем компенсацию; если не спасает — фиксируем и отдыхаем."

### Ключевые принципы
1. **Реактивность**: Не пытаемся предсказать тренд, реагируем на фактические движения
2. **Защита капитала**: Компенсация через ETH снижает риски
3. **Дисциплина**: Четкие правила входа и выхода
4. **Таймауты**: Ограничиваем время в позиции

## Техническая реализация

### Структура файлов
```
app/strategies/
├── compensation_strategy.py      # Основная логика стратегии
├── compensation_adapter.py       # Адаптер для интеграции
└── strategy_factory.py           # Фабрика стратегий

app/schemas/
└── compensation_parameters.py    # Схема параметров

app/tests/
└── test_compensation_strategy.py # Тесты

demo_compensation_strategy.py     # Демонстрационный скрипт
```

### Классы и методы

#### CompensationStrategy
- `generate_signal(df)` - генерирует сигнал для BTC
- `should_trigger_compensation(df, price)` - проверяет условия компенсации
- `calculate_position_size(balance, symbol)` - рассчитывает размер позиции
- `should_close_btc_position(df)` - проверяет закрытие BTC
- `should_close_eth_position(df)` - проверяет закрытие ETH

#### CompensationAdapter
- `decide(md, template, open_state)` - принимает торговые решения
- `required_symbols(template)` - возвращает необходимые символы (BTC, ETH)

## Установка и использование

### 1. Применение миграции
```bash
cd app
alembic upgrade head
```

### 2. Запуск демонстрации
```bash
python demo_compensation_strategy.py
```

### 3. Запуск тестов
```bash
cd app
pytest tests/test_compensation_strategy.py -v
```

## Пример использования

```python
from strategies.compensation_strategy import CompensationStrategy
from services.strategy_parameters import StrategyParameters

# Создание стратегии
params = {
    "ema_fast": 10,
    "ema_slow": 30,
    "btc_deposit_prct": 0.05,
    "eth_deposit_prct": 0.1,
    # ... остальные параметры
}

strategy = CompensationStrategy(StrategyParameters(params))

# Генерация сигнала
signal = strategy.generate_signal(btc_data)

# Проверка компенсации
if strategy.should_trigger_compensation(btc_data, current_price):
    eth_side = strategy.get_eth_side()
    # Запуск компенсации
```

## Преимущества стратегии

1. **Снижение рисков**: Компенсация через ETH защищает от резких движений
2. **Гибкость**: Можно входить даже в боковике
3. **Дисциплина**: Четкие правила исключают эмоциональные решения
4. **Масштабируемость**: Параметры легко настраиваются под разные условия

## Риски и ограничения

1. **Корреляция**: BTC и ETH могут двигаться синхронно
2. **Комиссии**: Дополнительные сделки увеличивают издержки
3. **Сложность**: Требует понимания логики компенсации
4. **Таймауты**: Могут закрывать прибыльные позиции

## Заключение

Стратегия "Компенсация и реакция" представляет собой современный подход к управлению рисками в криптотрейдинге. Она сочетает проверенную логику входа с инновационной системой компенсации, что позволяет торговать более уверенно и с меньшими просадками.

Ключ к успеху - строгое соблюдение правил и понимание того, что компенсация не гарантирует прибыль, но значительно снижает риски крупных убытков.

